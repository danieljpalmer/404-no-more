"use strict";var A=Object.create;var l=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var D=(r,t)=>{for(var e in t)l(r,e,{get:t[e],enumerable:!0})},b=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of w(t))!_.call(r,i)&&i!==e&&l(r,i,{get:()=>t[i],enumerable:!(n=R(t,i))||n.enumerable});return r};var v=(r,t,e)=>(e=r!=null?A(V(r)):{},b(t||!r||!r.__esModule?l(e,"default",{value:r,enumerable:!0}):e,r)),E=r=>b(l({},"__esModule",{value:!0}),r);var N={};D(N,{Chain:()=>u,Client:()=>g,RunChainError:()=>d,defineChain:()=>j});module.exports=E(N);var c=Symbol("VARIABLE_INTERNAL"),S={get(r,t){let e=C(r);if(["toString","toJSON","valueOf",Symbol.toPrimitive].includes(t))return()=>`{{${e}}}`;if(typeof t=="string"||typeof t=="number"){let n=t==="*"?`${e}[${t}]`:`${e}.${t}`;return o({path:n})}return t===c?r[c]:null}},o=r=>new Proxy({[c]:{path:r.path}},S);var C=r=>r[c].path,T=r=>C(r).split(".").join("?.");var f=v(require("dotenv")),P=!1,I=r=>{P&&!r||(f.config(),f.config({path:"./chains/.relevance"}),P=!0)},O=()=>({project:process.env.RELEVANCE_PROJECT_ID||"",region:process.env.RELEVANCE_REGION||"",apiKey:process.env.RELEVANCE_API_KEY||""});var h=class{constructor(t){I();let e=t!=null?t:O();if(!e.project||!e.region||!e.apiKey)throw new Error("Missing auth details. Please provide a project ID, region, and API key.");this.authDetails=e}get token(){return`${this.authDetails.project}:${this.authDetails.apiKey}:${this.authDetails.region}`}async request(t,e){let n=e!=null&&e.query?new URLSearchParams(Object.fromEntries(Object.entries(e.query).map(([s,p])=>[s,typeof p=="object"?JSON.stringify(p):p]))):"",i=`https://api-${this.authDetails.region}.stack.tryrelevance.com/latest${t}?${n}`,a=await fetch(i,{...e,headers:{...e==null?void 0:e.headers,Authorization:this.token}});if(!a.ok){let s=await a.text();try{s=JSON.parse(s).message||s}catch{}throw new m(s)}return a.json()}async getChain(t,e){return(await this.request(`/studios/${t}`)).studio}async runChain(t){return await this.request(`/studios/${t.studio_id}/trigger`,{method:"POST",body:JSON.stringify(t)})}async saveChains(t){var n;return await this.request("/studios/bulk_update",{method:"POST",body:JSON.stringify({...t,partial_update:(n=t.partial_update)!=null?n:!0})})}async getChainsByIds(t){return(await this.request("/studios/list",{query:{filters:[{filter_type:"exact_match",field:"studio_id",condition_value:t},{filter_type:"exact_match",field:"project",condition_value:this.authDetails.project}]}})).results}async shareChain(t){return await this.request(`/studios/${t}/get_share_link`,{method:"POST"})}async unshareChain(t,e){await this.request(`/studios/${t}/delete_share_link`,{method:"POST",body:JSON.stringify({share_id:e})})}},m=class extends Error{constructor(t){super(t)}};var x=r=>JSON.parse(JSON.stringify(r));var y=class{constructor(t){this.$RELEVANCE_CHAIN_BRAND=!0;this.chainId=null;this.params=null;this.steps=[];this.output=null;this.title="";this.description="";this.publiclyTriggerable=!1;this.runIfContext=null;this.foreachContext=null;this.api=new h(t)}setTitle(t){this.title=t}setDescription(t){this.description=t}setPubliclyTriggerable(t){this.publiclyTriggerable=t}defineParams(t){if(this.params)throw new Error("Params already defined. If you want to add more params, add them in the initial defineParams call.");return this.params=t,o({path:"params"})}step(t,e){let n=t,i=this.steps.filter(s=>s.transformation===t);i.length&&(n=`${t}_${i.length+1}`);let a={name:n,transformation:t,params:e};return this.runIfContext!==null&&(a.if=this.runIfContext),this.steps.push(a),o({path:`steps.${n}.output`})}runIf(t,e){if(this.runIfContext)throw new Error("Nested runIf not supported at the moment.");this.runIfContext=t;let n=e();return this.runIfContext=null,n}code(t,e){let n=Object.entries(t).map(([s,p])=>`${JSON.stringify(s)}: ${T(p)}`).join(","),i=e.toString(),a=`
return (() => {
  const _$$params = { ${n} };
  return (${i})(_$$params);
})();`.trim();return this.step("js_code_transformation",{code:a})}foreach(t,e){if(this.foreachContext)throw new Error("Nested foreach not supported at the moment.");this.foreachContext=t;let n=this.steps.length;if(e({item:o({path:"foreach.item"}),index:o({path:"foreach.index"})}),this.steps.length-n!==1)throw new Error("You must call `step` once and only once inside the `foreach` callback.");this.foreachContext=null;let a=this.steps[this.steps.length-1];return o({path:`steps.${a.name}.results`})}defineOutput(t){if(this.output)throw new Error("Output already defined. If you want to add more output, add them in the initial defineOutput call.");this.output=t}toJSON(){return x({studio_id:this.chainId||"LOCAL_DEV_CHAIN",title:this.title,description:this.description,params_schema:{properties:this.params||{}},transformations:{steps:this.steps,output:this.output},publicly_triggerable:this.publiclyTriggerable})}setChainId(t){this.chainId=t}getChainId(){return this.chainId}async run(t){let e=this.toJSON();return await this.api.runChain({studio_id:e.studio_id,params:t,return_state:!0,studio_override:e})}},u=y;u.define=t=>{var a;let e=new y,n=e.defineParams(t.params||{});t.title&&e.setTitle(t.title),t.description&&e.setDescription(t.description),e.setPubliclyTriggerable((a=t.publiclyTriggerable)!=null?a:!1);let i=t.setup({params:n,step:e.step.bind(e),runIf:e.runIf.bind(e),code:e.code.bind(e),foreach:e.foreach.bind(e)});return i&&e.defineOutput(i),e};var j=u.define;var g=class{constructor(t){this.region=t.region,this.project=t.project}async runChain(t,e){let n=await fetch(`https://api-${this.region}.stack.tryrelevance.com/latest/studios/${t}/trigger_limited`,{method:"POST",body:JSON.stringify({project:this.project,params:e})});if(!n.ok){let a=await n.text();try{a=JSON.parse(a).message||a}catch{}throw new Error(a)}let i=await n.json();if(i.status!=="complete")throw new d(i.errors);return i.output}},d=class extends Error{constructor(e,n="Chain failed to complete successfully"){super(n);this.errors=e}};0&&(module.exports={Chain,Client,RunChainError,defineChain});
