var u=Symbol("VARIABLE_INTERNAL"),P={get(n,t){let e=m(n);if(["toString","toJSON","valueOf",Symbol.toPrimitive].includes(t))return()=>`{{${e}}}`;if(typeof t=="string"||typeof t=="number"){let r=t==="*"?`${e}[${t}]`:`${e}.${t}`;return o({path:r})}return t===u?n[u]:null}},o=n=>new Proxy({[u]:{path:n.path}},P);var m=n=>n[u].path,y=n=>m(n).split(".").join("?.");import*as h from"dotenv";var g=!1,b=n=>{g&&!n||(h.config(),h.config({path:"./chains/.relevance"}),g=!0)},T=()=>({project:process.env.RELEVANCE_PROJECT_ID||"",region:process.env.RELEVANCE_REGION||"",apiKey:process.env.RELEVANCE_API_KEY||""});var l=class{constructor(t){b();let e=t!=null?t:T();if(!e.project||!e.region||!e.apiKey)throw new Error("Missing auth details. Please provide a project ID, region, and API key.");this.authDetails=e}get token(){return`${this.authDetails.project}:${this.authDetails.apiKey}:${this.authDetails.region}`}async request(t,e){let r=e!=null&&e.query?new URLSearchParams(Object.fromEntries(Object.entries(e.query).map(([s,p])=>[s,typeof p=="object"?JSON.stringify(p):p]))):"",a=`https://api-${this.authDetails.region}.stack.tryrelevance.com/latest${t}?${r}`,i=await fetch(a,{...e,headers:{...e==null?void 0:e.headers,Authorization:this.token}});if(!i.ok){let s=await i.text();try{s=JSON.parse(s).message||s}catch{}throw new d(s)}return i.json()}async getChain(t,e){return(await this.request(`/studios/${t}`)).studio}async runChain(t){return await this.request(`/studios/${t.studio_id}/trigger`,{method:"POST",body:JSON.stringify(t)})}async saveChains(t){var r;return await this.request("/studios/bulk_update",{method:"POST",body:JSON.stringify({...t,partial_update:(r=t.partial_update)!=null?r:!0})})}async getChainsByIds(t){return(await this.request("/studios/list",{query:{filters:[{filter_type:"exact_match",field:"studio_id",condition_value:t},{filter_type:"exact_match",field:"project",condition_value:this.authDetails.project}]}})).results}async shareChain(t){return await this.request(`/studios/${t}/get_share_link`,{method:"POST"})}async unshareChain(t,e){await this.request(`/studios/${t}/delete_share_link`,{method:"POST",body:JSON.stringify({share_id:e})})}},d=class extends Error{constructor(t){super(t)}};var C=n=>JSON.parse(JSON.stringify(n));var f=class{constructor(t){this.$RELEVANCE_CHAIN_BRAND=!0;this.chainId=null;this.params=null;this.steps=[];this.output=null;this.title="";this.description="";this.publiclyTriggerable=!1;this.runIfContext=null;this.foreachContext=null;this.api=new l(t)}setTitle(t){this.title=t}setDescription(t){this.description=t}setPubliclyTriggerable(t){this.publiclyTriggerable=t}defineParams(t){if(this.params)throw new Error("Params already defined. If you want to add more params, add them in the initial defineParams call.");return this.params=t,o({path:"params"})}step(t,e){let r=t,a=this.steps.filter(s=>s.transformation===t);a.length&&(r=`${t}_${a.length+1}`);let i={name:r,transformation:t,params:e};return this.runIfContext!==null&&(i.if=this.runIfContext),this.steps.push(i),o({path:`steps.${r}.output`})}runIf(t,e){if(this.runIfContext)throw new Error("Nested runIf not supported at the moment.");this.runIfContext=t;let r=e();return this.runIfContext=null,r}code(t,e){let r=Object.entries(t).map(([s,p])=>`${JSON.stringify(s)}: ${y(p)}`).join(","),a=e.toString(),i=`
return (() => {
  const _$$params = { ${r} };
  return (${a})(_$$params);
})();`.trim();return this.step("js_code_transformation",{code:i})}foreach(t,e){if(this.foreachContext)throw new Error("Nested foreach not supported at the moment.");this.foreachContext=t;let r=this.steps.length;if(e({item:o({path:"foreach.item"}),index:o({path:"foreach.index"})}),this.steps.length-r!==1)throw new Error("You must call `step` once and only once inside the `foreach` callback.");this.foreachContext=null;let i=this.steps[this.steps.length-1];return o({path:`steps.${i.name}.results`})}defineOutput(t){if(this.output)throw new Error("Output already defined. If you want to add more output, add them in the initial defineOutput call.");this.output=t}toJSON(){return C({studio_id:this.chainId||"LOCAL_DEV_CHAIN",title:this.title,description:this.description,params_schema:{properties:this.params||{}},transformations:{steps:this.steps,output:this.output},publicly_triggerable:this.publiclyTriggerable})}setChainId(t){this.chainId=t}getChainId(){return this.chainId}async run(t){let e=this.toJSON();return await this.api.runChain({studio_id:e.studio_id,params:t,return_state:!0,studio_override:e})}},c=f;c.define=t=>{var i;let e=new f,r=e.defineParams(t.params||{});t.title&&e.setTitle(t.title),t.description&&e.setDescription(t.description),e.setPubliclyTriggerable((i=t.publiclyTriggerable)!=null?i:!1);let a=t.setup({params:r,step:e.step.bind(e),runIf:e.runIf.bind(e),code:e.code.bind(e),foreach:e.foreach.bind(e)});return a&&e.defineOutput(a),e};var N=c.define;export{T as a,l as b,c,N as d};
